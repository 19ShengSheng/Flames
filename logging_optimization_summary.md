# Flask.py 日志输出优化总结

## 修改目标
减少Flask.py中轮询日志的频繁输出，只在以下情况显示日志：
1. 接收到前端请求时
2. 任务状态实际发生变化时

## 主要修改内容

### 1. 优化 `task_scheduler_loop()` 函数
- **修改前**: 每5秒轮询都会输出详细的调试信息
- **修改后**: 只在任务数量(running/pending)发生变化时才输出日志
- **效果**: 大幅减少轮询时的日志输出频率

### 2. 简化 `fetch_next_pending_task()` 函数
- **修改前**: 每次调用都输出pending任务数量和详细信息
- **修改后**: 移除所有调试日志，只保留错误日志
- **效果**: 减少不必要的日志输出

### 3. 简化 `has_running_task()` 函数
- **修改前**: 每次调用都输出running任务数量
- **修改后**: 移除调试日志，只保留错误日志
- **效果**: 减少不必要的日志输出

### 4. 优化 `set_task_status()` 函数
- **修改前**: 每次状态更新都输出详细日志和验证信息
- **修改后**: 移除调试日志，只保留错误日志
- **效果**: 减少状态更新时的日志噪音

### 5. 改进 `create_flames_tasks()` 函数
- **修改前**: 每个任务创建都输出详细日志
- **修改后**: 只在立即启动任务时输出关键信息
- **效果**: 减少任务创建时的日志噪音

### 6. 改进 `run_task_algorithm()` 函数
- **修改前**: 使用[SCHEDULER]标签
- **修改后**: 使用[TASK]标签，信息更简洁
- **效果**: 日志标签更清晰

### 7. 增加API请求日志
为以下API路由添加了请求日志：
- `/api/flames/create_task` - 创建任务请求
- `/api/flames/progress/<task_id>` - 进度查询请求
- `/api/flames/report/<task_id>/download` - 报告下载请求
- `/api/flames/history` - 历史记录查询请求

## 预期效果

### 修改前的日志输出示例：
```
[SCHEDULER] 检查任务状态...
[DEBUG] 数据库中有 0 个running任务
[SCHEDULER] 当前running任务数量: 0
[SCHEDULER] 没有running任务，检查pending任务...
[DEBUG] 数据库中有 0 个pending任务
[DEBUG] 没有pending任务
[SCHEDULER] 没有找到pending任务
```
（每5秒重复一次）

### 修改后的日志输出：
- 空闲时：无日志输出
- 任务状态变化时：
```
[SCHEDULER] 任务状态变化 - running: 1, pending: 0
[TASK] 开始执行任务: xxx (模型: xxx, 数据集: xxx)
```
- 前端请求时：
```
[API] 收到创建任务请求 - 模型: xxx, 数据集: xxx, API站点: xxx
[API] 成功创建任务: 1 个
```

## 测试验证
创建了 `test_logging.py` 测试脚本，验证了：
1. 数据库连接正常
2. 各函数不再输出频繁的调试日志
3. 只在必要时输出关键信息

## 总结
通过以上修改，成功减少了Flask应用的日志噪音，提高了日志的可读性和实用性。现在日志主要包含：
- 前端请求信息
- 任务状态变化信息
- 错误信息

不再包含：
- 频繁的轮询状态信息
- 重复的数据库查询结果
- 过于详细的调试信息